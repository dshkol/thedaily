name: The D-AI-LY - Automated Pipeline

on:
  # Run daily at 8am Eastern (13:00 UTC)
  schedule:
    - cron: '0 13 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      table:
        description: 'Specific table number (optional)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (discovery only)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  R_VERSION: '4.3'

jobs:
  discover-and-fetch:
    runs-on: ubuntu-latest
    outputs:
      selected_table: ${{ steps.discover.outputs.table }}
      has_update: ${{ steps.discover.outputs.has_update }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ env.R_VERSION }}

      - name: Install R dependencies
        run: |
          install.packages(c("cansim", "dplyr", "tidyr", "jsonlite"), repos = "https://cloud.r-project.org")
        shell: Rscript {0}

      - name: Run discovery
        id: discover
        run: |
          mkdir -p output

          if [ -n "${{ github.event.inputs.table }}" ]; then
            echo "Using specified table: ${{ github.event.inputs.table }}"
            echo "table=${{ github.event.inputs.table }}" >> $GITHUB_OUTPUT
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "Running topic discovery..."
            Rscript r-tools/discover_topics.R --configured --json --output=output

            if [ -f output/discovery_results.json ]; then
              TABLE=$(python3 -c "
import json
with open('output/discovery_results.json') as f:
    data = json.load(f)
    if data.get('recommendation'):
        print(data['recommendation']['table_number'])
")
              if [ -n "$TABLE" ]; then
                echo "table=$TABLE" >> $GITHUB_OUTPUT
                echo "has_update=true" >> $GITHUB_OUTPUT
                echo "Recommended table: $TABLE"
              else
                echo "has_update=false" >> $GITHUB_OUTPUT
                echo "No newsworthy updates found"
              fi
            else
              echo "has_update=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Fetch table data
        if: steps.discover.outputs.has_update == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          TABLE="${{ steps.discover.outputs.table }}"
          echo "Fetching data for table: $TABLE"
          Rscript r-tools/fetch_table.R "$TABLE" output

      - name: Upload data artifact
        if: steps.discover.outputs.has_update == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cansim-data
          path: output/
          retention-days: 7

  generate-articles:
    needs: discover-and-fetch
    if: needs.discover-and-fetch.outputs.has_update == 'true' && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download data artifact
        uses: actions/download-artifact@v4
        with:
          name: cansim-data
          path: output/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      # NOTE: This step requires Claude Code CLI
      # Install with: npm install -g @anthropic-ai/claude-code
      - name: Generate articles with Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TABLE="${{ needs.discover-and-fetch.outputs.selected_table }}"
          echo "Generating articles for table: $TABLE"

          # Install Claude Code CLI
          npm install -g @anthropic-ai/claude-code

          # Run the generator skill
          claude --print "/the-daily-generator $TABLE"

      - name: Build site
        run: npm run build

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/ output/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TABLE="${{ needs.discover-and-fetch.outputs.selected_table }}"
            git commit -m "Add: Article for table $TABLE - generated by D-AI-LY"
            git push
          fi

  notify:
    needs: [discover-and-fetch, generate-articles]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "## D-AI-LY Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Selected Table**: ${{ needs.discover-and-fetch.outputs.selected_table || 'None' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Update**: ${{ needs.discover-and-fetch.outputs.has_update }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.generate-articles.result }}" == "success" ]; then
            echo "✅ Articles generated and published successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.discover-and-fetch.outputs.has_update }}" == "false" ]; then
            echo "ℹ️ No newsworthy updates found today." >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Pipeline completed with status: ${{ needs.generate-articles.result }}" >> $GITHUB_STEP_SUMMARY
          fi
