/**
 * The D-AI-LY Navigation Module
 * Handles date navigation, language toggle, and article display
 */

(function() {
  'use strict';

  // State
  let articlesData = null;
  let availableDates = [];
  let currentDate = null;
  let currentLang = 'en';

  // DOM Elements
  const elements = {
    dateDisplay: null,
    datePicker: null,
    prevBtn: null,
    nextBtn: null,
    langEn: null,
    langFr: null,
    articlesContainer: null
  };

  // Translations for UI elements
  const translations = {
    en: {
      noArticles: 'No articles for this date',
      todayReleases: "Today's Releases",
      browseArchive: 'Browse Archive',
      tagline: 'AI-generated statistical bulletins from Statistics Canada data',
      aiDisclosureTitle: 'AI Disclosure:',
      aiDisclosureText: 'Articles on this site are generated by an experimental AI system. Data comes from official Statistics Canada sources. Please verify important figures with',
      statcanLink: 'Statistics Canada',
      copyright: 'Data source: Statistics Canada. Generated by The D-AI-LY.'
    },
    fr: {
      noArticles: 'Aucun article pour cette date',
      todayReleases: 'Publications du jour',
      browseArchive: 'Parcourir les archives',
      tagline: 'Bulletins statistiques produits par l\'IA à partir des données de Statistique Canada',
      aiDisclosureTitle: 'Divulgation relative à l\'IA :',
      aiDisclosureText: 'Les articles sur ce site sont générés par un système d\'IA expérimental. Les données proviennent de sources officielles de Statistique Canada. Veuillez vérifier les chiffres importants auprès de',
      statcanLink: 'Statistique Canada',
      copyright: 'Source des données : Statistique Canada. Généré par Le D-AI-LY.'
    }
  };

  /**
   * Initialize the navigation module
   */
  async function init() {
    // Cache DOM elements
    elements.dateDisplay = document.getElementById('date-display');
    elements.datePicker = document.getElementById('date-picker');
    elements.prevBtn = document.getElementById('prev-day');
    elements.nextBtn = document.getElementById('next-day');
    elements.langEn = document.getElementById('lang-en');
    elements.langFr = document.getElementById('lang-fr');
    elements.articlesContainer = document.getElementById('articles-container');

    // Load saved language preference
    const savedLang = localStorage.getItem('dailyLang');
    if (savedLang && (savedLang === 'en' || savedLang === 'fr')) {
      currentLang = savedLang;
    }

    // Parse URL parameters
    const params = new URLSearchParams(window.location.search);
    if (params.has('lang')) {
      const urlLang = params.get('lang');
      if (urlLang === 'en' || urlLang === 'fr') {
        currentLang = urlLang;
      }
    }
    if (params.has('date')) {
      currentDate = params.get('date');
    }

    // Load articles data
    try {
      const response = await fetch('articles.json');
      articlesData = await response.json();
      availableDates = articlesData.dates || [];

      // Set current date to latest if not specified
      if (!currentDate && availableDates.length > 0) {
        currentDate = availableDates[0];
      }
    } catch (error) {
      console.error('Failed to load articles.json:', error);
      showError('Failed to load articles data');
      return;
    }

    // Setup event listeners
    setupEventListeners();

    // Initial render
    updateLanguageUI();
    updateDatePicker();
    renderArticles();
  }

  /**
   * Setup all event listeners
   */
  function setupEventListeners() {
    // Date navigation
    if (elements.prevBtn) {
      elements.prevBtn.addEventListener('click', navigatePrev);
    }
    if (elements.nextBtn) {
      elements.nextBtn.addEventListener('click', navigateNext);
    }
    if (elements.datePicker) {
      elements.datePicker.addEventListener('change', handleDatePick);
    }

    // Language toggle
    if (elements.langEn) {
      elements.langEn.addEventListener('click', () => setLanguage('en'));
    }
    if (elements.langFr) {
      elements.langFr.addEventListener('click', () => setLanguage('fr'));
    }

    // Keyboard navigation
    document.addEventListener('keydown', handleKeyboard);
  }

  /**
   * Navigate to previous date with articles
   */
  function navigatePrev() {
    const currentIndex = availableDates.indexOf(currentDate);
    if (currentIndex < availableDates.length - 1) {
      currentDate = availableDates[currentIndex + 1];
      updateURL();
      updateDatePicker();
      renderArticles();
    }
  }

  /**
   * Navigate to next date with articles
   */
  function navigateNext() {
    const currentIndex = availableDates.indexOf(currentDate);
    if (currentIndex > 0) {
      currentDate = availableDates[currentIndex - 1];
      updateURL();
      updateDatePicker();
      renderArticles();
    }
  }

  /**
   * Handle date picker change
   */
  function handleDatePick(event) {
    const selectedDate = event.target.value;
    if (availableDates.includes(selectedDate)) {
      currentDate = selectedDate;
      updateURL();
      renderArticles();
    } else {
      // Find nearest date with articles
      const nearest = findNearestDate(selectedDate);
      if (nearest) {
        currentDate = nearest;
        updateURL();
        updateDatePicker();
        renderArticles();
      }
    }
  }

  /**
   * Find the nearest date that has articles
   */
  function findNearestDate(targetDate) {
    if (availableDates.length === 0) return null;

    const target = new Date(targetDate).getTime();
    let nearest = availableDates[0];
    let minDiff = Math.abs(new Date(nearest).getTime() - target);

    for (const date of availableDates) {
      const diff = Math.abs(new Date(date).getTime() - target);
      if (diff < minDiff) {
        minDiff = diff;
        nearest = date;
      }
    }

    return nearest;
  }

  /**
   * Set language and update UI
   */
  function setLanguage(lang) {
    if (lang !== 'en' && lang !== 'fr') return;

    currentLang = lang;
    localStorage.setItem('dailyLang', lang);
    updateURL();
    updateLanguageUI();
    renderArticles();
  }

  /**
   * Update language toggle button states and translatable text
   */
  function updateLanguageUI() {
    // Update toggle buttons
    if (elements.langEn) {
      elements.langEn.classList.toggle('active', currentLang === 'en');
    }
    if (elements.langFr) {
      elements.langFr.classList.toggle('active', currentLang === 'fr');
    }

    // Update document language
    document.documentElement.lang = currentLang;

    // Update all translatable elements
    const translatables = document.querySelectorAll('[data-en][data-fr]');
    translatables.forEach(el => {
      const text = el.getAttribute(`data-${currentLang}`);
      if (text) {
        el.textContent = text;
      }
    });
  }

  /**
   * Update the date picker value and constraints
   */
  function updateDatePicker() {
    if (!elements.datePicker || !currentDate) return;

    elements.datePicker.value = currentDate;

    // Set min/max to available date range
    if (availableDates.length > 0) {
      elements.datePicker.min = availableDates[availableDates.length - 1];
      elements.datePicker.max = availableDates[0];
    }

    // Update display text
    if (elements.dateDisplay) {
      elements.dateDisplay.textContent = formatDateDisplay(currentDate);
    }

    // Update nav button states
    const currentIndex = availableDates.indexOf(currentDate);
    if (elements.prevBtn) {
      elements.prevBtn.disabled = currentIndex >= availableDates.length - 1;
    }
    if (elements.nextBtn) {
      elements.nextBtn.disabled = currentIndex <= 0;
    }
  }

  /**
   * Format date for display
   */
  function formatDateDisplay(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    const options = {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    };
    return date.toLocaleDateString(currentLang === 'fr' ? 'fr-CA' : 'en-CA', options);
  }

  /**
   * Render articles for the current date
   */
  function renderArticles() {
    if (!elements.articlesContainer || !articlesData) return;

    const dateArticles = articlesData.articles[currentDate];
    const langArticles = dateArticles ? dateArticles[currentLang] : null;

    // Fallback to other language if current language has no articles
    const articles = langArticles || (dateArticles ? dateArticles[currentLang === 'en' ? 'fr' : 'en'] : null);
    const t = translations[currentLang];

    if (!articles || articles.length === 0) {
      elements.articlesContainer.innerHTML = `
        <p class="no-articles">${t.noArticles}</p>
      `;
      return;
    }

    const articleLinks = articles.map(article => {
      const articlePath = `articles/${currentLang}/${article.filename}`;
      return `
        <article class="article-card">
          <h3>
            <a href="${articlePath}">${article.title}</a>
          </h3>
          ${article.table ? `<span class="table-ref">Table ${article.table}</span>` : ''}
        </article>
      `;
    }).join('');

    elements.articlesContainer.innerHTML = articleLinks;
  }

  /**
   * Update URL with current state
   */
  function updateURL() {
    const params = new URLSearchParams();
    if (currentDate) {
      params.set('date', currentDate);
    }
    if (currentLang !== 'en') {
      params.set('lang', currentLang);
    }

    const newURL = params.toString()
      ? `${window.location.pathname}?${params.toString()}`
      : window.location.pathname;

    window.history.replaceState({}, '', newURL);
  }

  /**
   * Handle keyboard navigation
   */
  function handleKeyboard(event) {
    // Don't interfere with form inputs
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
      return;
    }

    switch (event.key) {
      case 'ArrowLeft':
        navigatePrev();
        break;
      case 'ArrowRight':
        navigateNext();
        break;
    }
  }

  /**
   * Show error message
   */
  function showError(message) {
    if (elements.articlesContainer) {
      elements.articlesContainer.innerHTML = `
        <p class="error-message">${message}</p>
      `;
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
